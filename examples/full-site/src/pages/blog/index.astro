---
import BaseLayout from '../../layouts/BaseLayout.astro';

const db = Astro.locals.runtime?.env?.DB;
let posts: any[] = [];

if (db) {
  try {
    const result = await db.prepare(`
      SELECT 
        p.id, p.slug, p.title, p.excerpt, p.cover_image, 
        p.published_at, p.content,
        u.name as author_name
      FROM blog_posts p
      LEFT JOIN admin_users u ON p.author_id = u.id
      WHERE p.status = 'published'
      ORDER BY p.published_at DESC
      LIMIT 20
    `).all();
    
    posts = result.results || [];
  } catch (e) {
    // Table might not exist yet
  }
}
---

<BaseLayout title="Blog">
  <header class="page-header">
    <h1>Blog</h1>
    <p>All posts</p>
  </header>
  
  {posts.length === 0 ? (
    <div class="empty-state">
      <p>No posts yet.</p>
      <a href="/admin/blog/new">Create your first post â†’</a>
    </div>
  ) : (
    <div class="posts-grid">
      {posts.map(post => (
        <article class="post-card">
          {post.cover_image && (
            <img src={post.cover_image} alt={post.title} loading="lazy" />
          )}
          <div class="post-content">
            <h2><a href={`/blog/${post.slug}`}>{post.title}</a></h2>
            {post.excerpt && <p class="excerpt">{post.excerpt}</p>}
            <footer>
              <span class="author">{post.author_name || 'Anonymous'}</span>
              <time datetime={post.published_at}>
                {new Date(post.published_at).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
            </footer>
          </div>
        </article>
      ))}
    </div>
  )}
</BaseLayout>

<style>
  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.25rem;
  }

  .page-header p {
    color: var(--color-muted);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--color-surface);
    border-radius: 0.5rem;
    color: var(--color-muted);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
  }

  .post-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
  }

  .post-card:hover {
    border-color: var(--color-primary);
    transform: translateY(-2px);
  }

  .post-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .post-card .post-content {
    padding: 1.5rem;
  }

  .post-card h2 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  .post-card h2 a {
    color: var(--color-text);
    text-decoration: none;
  }

  .post-card h2 a:hover {
    color: var(--color-primary);
  }

  .post-card .excerpt {
    color: var(--color-muted);
    font-size: 0.9375rem;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .post-card footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8125rem;
    color: var(--color-muted);
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }
</style>
